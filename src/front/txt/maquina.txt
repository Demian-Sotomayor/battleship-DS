import React, { useEffect, useState } from "react";
import "../../styles/tablero.css";

const Maquina = ({
  juegoIniciado,
  turnoJugador,
  setTurnoJugador,
  tableroJugador,
  setTableroJugador,
}) => {
  const [tableroMaquina, setTableroMaquina] = useState([]);

  useEffect(() => {
    inicializarTableroMaquina();
  }, [juegoIniciado]);

  const inicializarTableroMaquina = () => {
    const nuevoTableroMaquina = Array.from({ length: 10 }, () =>
      Array(10).fill({
        contenido: null,
        clickeable: true,
        ataqueExitoso: false,
      })
    );
    // Eliminar clases "nave" o "disparo" del tablero del jugador
    for (let i = 0; i < 10; i++) {
      for (let j = 0; j < 10; j++) {
        nuevoTableroMaquina[i][j].contenido = null;
      }
    }
    colocarNavesAleatorias(nuevoTableroMaquina);
    setTableroMaquina(nuevoTableroMaquina);
  };

  const esPosicionValida = (
    fila,
    columna,
    longitud,
    orientacion,
    tableroJugador
  ) => {
    const proximidadNaves = (f, c) => {
      // Código para verificar que no hayan naves pegadas una a otra
      for (let i = -1; i <= 1; i++) {
        for (let j = -1; j <= 1; j++) {
          const nuevaFila = f + i;
          const nuevaColumna = c + j;

          if (
            nuevaFila >= 0 &&
            nuevaFila < 10 &&
            nuevaColumna >= 0 &&
            nuevaColumna < 10 &&
            tableroJugador[nuevaFila][nuevaColumna].contenido &&
            tableroJugador[nuevaFila][nuevaColumna].contenido.tipo === "nave"
          ) {
            return false;
          }
        }
      }
      return true;
    };

    if (orientacion === "horizontal") {
      for (let i = 0; i < longitud; i++) {
        if (
          columna + i >= 10 ||
          tableroJugador[fila][columna + i].contenido !== null ||
          !proximidadNaves(fila, columna + i)
        ) {
          return false;
        }
      }
    } else {
      for (let i = 0; i < longitud; i++) {
        if (
          fila + i >= 10 ||
          tableroJugador[fila + i][columna].contenido !== null ||
          !proximidadNaves(fila + i, columna)
        ) {
          return false;
        }
      }
    }
    return true;
  };

  const colocarNaveEnTablero = (
    fila,
    columna,
    longitud,
    orientacion,
    tableroMaquina
  ) => {
    if (orientacion === "horizontal") {
      for (let i = 0; i < longitud; i++) {
        tableroMaquina[fila][columna + i] = {
          contenido: { tipo: "nave", clickeable: true },
        };
      }
    } else {
      for (let i = 0; i < longitud; i++) {
        tableroMaquina[fila + i][columna] = {
          contenido: { tipo: "nave", clickeable: true },
        };
      }
    }
  };

  const colocarNavesAleatorias = (tableroMaquina) => {
    const navesPorLongitud = {
      4: 1, // 1 nave de longitud 4
      3: 2, // 2 naves de longitud 3
      2: 4, // 4 naves de longitud 2
      1: 3, // 3 naves de longitud 1
    };

    Object.keys(navesPorLongitud).forEach((longitud) => {
      for (let i = 0; i < navesPorLongitud[longitud]; i++) {
        let fila, columna, orientacionActual;

        do {
          // Generar posición aleatoria
          fila = Math.floor(Math.random() * 10);
          columna = Math.floor(Math.random() * 10);

          // Cambiar entre orientación horizontal y vertical
          orientacionActual =
            orientacionActual === "horizontal" ? "vertical" : "horizontal";
        } while (
          !esPosicionValida(
            fila,
            columna,
            parseInt(longitud),
            orientacionActual,
            tableroMaquina
          )
        );

        colocarNaveEnTablero(
          fila,
          columna,
          parseInt(longitud),
          orientacionActual,
          tableroMaquina
        );
      }
    });
  };

  const realizarAtaque = (fila, columna) => {
    if (turnoJugador && tableroMaquina[fila][columna].clickeable) {
        const nuevoTableroMaquina = [...tableroMaquina];
        if (nuevoTableroMaquina[fila][columna].contenido && nuevoTableroMaquina[fila][columna].contenido.tipo === "nave") {
            nuevoTableroMaquina[fila][columna] = {
                contenido: { tipo: "disparo", clickeable: false, ataqueExitoso: true },
            };
        } else {
            nuevoTableroMaquina[fila][columna] = {
                contenido: { tipo: "disparo", clickeable: false, ataqueExitoso: false },
            };
        }
        setTableroMaquina(nuevoTableroMaquina);
        setTurnoJugador(false);
    }
};

const encontrarCuadroClickeableAleatorio = (tableroJugador) => {
    const cuadradosClickeables = [];

    // Verificar que el tablero del jugador esté inicializado y no sea un array vacío
    if (tableroJugador && tableroJugador.length > 0) {
        for (let i = 0; i < 10; i++) {
            for (let j = 0; j < 10; j++) {
                // Permitir atacar cuadros clickeables, independientemente de la clase
                if (tableroJugador[i][j].clickeable && !tableroJugador[i][j].visible) {
                    cuadradosClickeables.push({ fila: i, columna: j });
                }
            }
        }
    }

    if (cuadradosClickeables.length > 0) {
        const cuadroAleatorio = cuadradosClickeables.find(
            (cuadro) =>
                tableroJugador[cuadro.fila][cuadro.columna].contenido &&
                tableroJugador[cuadro.fila][cuadro.columna].contenido.tipo === "nave"
        );

        return cuadroAleatorio;
    } else {
        // Manejar el caso cuando no hay cuadros clickeables
        console.log("No hay cuadros clickeables disponibles");
        return null;
    }
};

  useEffect(() => {
    if (juegoIniciado && !turnoJugador) {
      const timeoutId = setTimeout(() => {
        const cuadroAleatorio =
          encontrarCuadroClickeableAleatorio(tableroJugador);
        if (cuadroAleatorio && tableroJugador[cuadroAleatorio.fila]) {
          const nuevoTableroMaquina = [...tableroMaquina];
          nuevoTableroMaquina[cuadroAleatorio.fila][cuadroAleatorio.columna] = {
            contenido: "disparo",
            clickeable: false,
          };
          setTableroMaquina(nuevoTableroMaquina);
          setTurnoJugador(true);
        }
      }, 1000); // Retraso de 1 segundo (ajustable)

      return () => clearTimeout(timeoutId);
    }
  }, [
    juegoIniciado,
    turnoJugador,
    tableroMaquina,
    tableroJugador,
    setTurnoJugador,
  ]);

  return (
    <div className="my-5">
      <div className="contenedor-tablero d-flex justify-content-center">
        <table className="tablero">
          <thead>
            <tr>
              <th className="etiqueta"></th>
              {Array.from({ length: 10 }, (_, index) => (
                <th key={index} className="etiqueta">
                  {String.fromCharCode(65 + index)}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {tableroMaquina.map((fila, rowIndex) => (
              <tr key={rowIndex}>
                <td className="etiqueta">{rowIndex + 1}</td>
                {fila.map((cuadrado, colIndex) => (
                  <td
                    key={colIndex}
                    className={`cuadrado ${
                      cuadrado.clickeable ? "clickeable" : ""
                    } ${
                      cuadrado.contenido === "nave" && cuadrado.ataqueExitoso
                        ? "nave-disparada"
                        : ""
                    } ${cuadrado.contenido === "disparo" ? "disparo" : ""}`}
                    onClick={() => realizarAtaque(rowIndex, colIndex)}
                  ></td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

export default Maquina;
